<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Item Editor - Ultra Compact English</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* Reduced card height as requested */
        .item-card { min-height: 40px; }
        
        .shop-container { transition: all 0.2s ease; }

        /* Dynamic grid support */
        .dynamic-grid {
            display: grid;
            gap: 0.375rem; /* 1.5 Tailwind gap */
        }
    </style>
</head>
<body class="bg-slate-200 min-h-screen font-sans text-slate-900 text-xs">

    <div class="max-w-full mx-auto p-2 lg:p-4">
        <!-- Header -->
        <header class="mb-4 flex flex-col md:flex-row md:items-center justify-between gap-2 bg-white p-3 rounded-lg shadow-sm border border-slate-300">
            <div class="flex items-center gap-4">
                <div>
                    <h1 class="text-lg font-bold text-slate-800 leading-tight">Shop Editor Ultra</h1>
                    <p class="text-[10px] text-slate-500 uppercase tracking-tighter font-bold">Dynamic Grid â€¢ English Interface</p>
                </div>
                
                <!-- Column Selector -->
                <div class="ml-4 pl-4 border-l border-slate-200 flex items-center gap-2">
                    <label for="colSelect" class="text-[10px] font-black uppercase text-slate-400">Columns:</label>
                    <select id="colSelect" onchange="updateGridColumns()" class="bg-slate-50 border border-slate-300 text-slate-700 text-[11px] font-bold rounded px-2 py-1 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <!-- Options generated via JS -->
                    </select>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="downloadJson()" id="btnDownload" class="hidden bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded shadow transition flex items-center gap-2 text-[10px] font-bold uppercase">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="C4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Export JSON
                </button>
            </div>
        </header>

        <!-- Upload Section -->
        <div id="uploadArea" class="grid grid-cols-2 gap-2 mb-4">
            <div class="bg-white p-2 rounded-lg shadow-sm border border-slate-300 flex flex-col items-center justify-center text-center">
                <p class="mb-1 text-[9px] font-bold text-slate-500 uppercase tracking-widest">1. items.json</p>
                <input type="file" id="jsonInput" accept=".json" class="text-[9px] text-slate-400 file:mr-2 file:py-0.5 file:px-2 file:rounded-full file:border-0 file:text-[9px] file:font-bold file:bg-indigo-50 file:text-indigo-700 cursor-pointer">
            </div>
            <div class="bg-white p-2 rounded-lg shadow-sm border border-slate-300 flex flex-col items-center justify-center text-center">
                <p class="mb-1 text-[9px] font-bold text-slate-500 uppercase tracking-widest">2. items_list.txt</p>
                <input type="file" id="txtInput" accept=".txt" class="text-[9px] text-slate-400 file:mr-2 file:py-0.5 file:px-2 file:rounded-full file:border-0 file:text-[9px] file:font-bold file:bg-emerald-50 file:text-emerald-700 cursor-pointer">
            </div>
        </div>

        <!-- Editor View -->
        <div id="editorView" class="hidden space-y-4">
            <div id="contentSections" class="space-y-4">
                <!-- Shop Sections will be injected here -->
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-12 bg-white rounded-xl border border-slate-300 shadow-sm">
            <p class="text-slate-400 text-[10px] font-black uppercase tracking-[0.2em]">Waiting for files to decode...</p>
        </div>
    </div>

    <script>
        let jsonData = null;
        let mapping = {};
        let currentCols = 10;

        // Initialize Column Selector
        const colSelect = document.getElementById('colSelect');
        for (let i = 5; i <= 20; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.innerText = i;
            if (i === 10) opt.selected = true;
            colSelect.appendChild(opt);
        }

        function updateGridColumns() {
            currentCols = parseInt(colSelect.value);
            if (jsonData) renderEditor();
        }

        // Shop Config: Section Background Colors
        const shopConfig = {
            "1": { name: "Town Shop (Merchant)", bg: "bg-blue-100", headerBg: "bg-blue-700", border: "border-blue-300" },
            "4": { name: "Arena Shop", bg: "bg-red-100", headerBg: "bg-red-700", border: "border-red-300" },
            "5": { name: "Grand Arena Shop", bg: "bg-orange-100", headerBg: "bg-orange-600", border: "border-orange-300" },
            "6": { name: "Tower Shop", bg: "bg-cyan-100", headerBg: "bg-cyan-700", border: "border-cyan-300" },
            "8": { name: "Soul Shop", bg: "bg-purple-100", headerBg: "bg-purple-700", border: "border-purple-300" },
            "9": { name: "Friendship Shop", bg: "bg-pink-100", headerBg: "bg-pink-600", border: "border-pink-300" },
            "10": { name: "Outland Shop", bg: "bg-emerald-100", headerBg: "bg-emerald-700", border: "border-emerald-300" },
            "11": { name: "Skin Stone Shop", bg: "bg-amber-100", headerBg: "bg-amber-600", border: "border-amber-300" },
            "17": { name: "Sanctuary", bg: "bg-teal-100", headerBg: "bg-teal-700", border: "border-teal-300" }
        };

        document.getElementById('jsonInput').addEventListener('change', handleJsonUpload);
        document.getElementById('txtInput').addEventListener('change', handleTxtUpload);

        async function handleJsonUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const text = await file.text();
            try {
                jsonData = JSON.parse(text);
                checkReadiness();
            } catch (err) { alert("Error loading JSON file."); }
        }

        async function handleTxtUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const text = await file.text();
            parseMapping(text);
            checkReadiness();
        }

        function parseMapping(text) {
            const regex = /id:\s*(\d+),\s*name:\s*["']([^"']+)["']/g;
            let match;
            mapping = {};
            while ((match = regex.exec(text)) !== null) {
                mapping[match[1]] = match[2];
            }
        }

        function checkReadiness() {
            if (jsonData) {
                renderEditor();
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('editorView').classList.remove('hidden');
                document.getElementById('btnDownload').classList.remove('hidden');
            }
        }

        function getDisplayName(key) {
            const parts = key.split('_');
            const type = parts[0];
            const idPart = parts[1];
            
            let prefix = 'ðŸ“¦';
            if (type === 'scroll') prefix = 'ðŸ“œ';
            else if (type === 'gear') prefix = 'ðŸ›¡ï¸';
            else if (type === 'consumable') prefix = 'ðŸ§ª';
            
            if (idPart && mapping[idPart]) {
                return `${prefix} ${mapping[idPart]}`;
            }
            return `${prefix} ${key}`;
        }

        function renderEditor() {
            const container = document.getElementById('contentSections');
            container.innerHTML = '';

            for (const catId in jsonData) {
                const items = jsonData[catId];
                const config = shopConfig[catId] || { name: `Shop ${catId}`, bg: "bg-slate-200", headerBg: "bg-slate-700", border: "border-slate-400" };
                
                const section = document.createElement('div');
                section.className = `rounded-lg overflow-hidden border ${config.border} shadow-md ${config.bg} mb-8 shop-container`;
                
                section.innerHTML = `
                    <div class="${config.headerBg} text-white px-3 py-1 flex items-center justify-between shadow-sm">
                        <h2 class="font-black text-[11px] uppercase tracking-wider flex items-center gap-2">
                            <span>ðŸ›’</span> [ID: ${catId}] ${config.name}
                        </h2>
                        <span class="text-[10px] bg-black bg-opacity-20 px-2 py-0.5 rounded font-mono uppercase">Items: ${Object.keys(items).length}</span>
                    </div>
                    <div class="p-2 dynamic-grid" style="grid-template-columns: repeat(${currentCols}, minmax(0, 1fr));">
                        ${Object.entries(items).map(([key, data]) => createItemHtml(catId, key, data)).join('')}
                    </div>
                `;
                container.appendChild(section);
            }
        }

        function createItemHtml(catId, itemKey, data) {
            const title = getDisplayName(itemKey);
            return `
                <div class="item-card bg-white bg-opacity-70 p-1 rounded border border-black border-opacity-5 flex flex-col justify-between transition-all hover:bg-opacity-100 hover:shadow-sm">
                    <div class="mb-1">
                        <h3 class="font-bold text-[8px] text-slate-900 leading-[1.1] truncate" title="${title}">${title}</h3>
                        <p class="text-[7px] text-slate-500 font-mono truncate leading-none mt-0.5">${itemKey}</p>
                    </div>
                    <div class="flex gap-0.5">
                        ${createCompactBtn(catId, itemKey, 'buy', data.buy, 'Buy', 'green')}
                        ${createCompactBtn(catId, itemKey, 'fav', data.fav, 'Fav', 'yellow')}
                        ${createCompactBtn(catId, itemKey, 'hidden', data.hidden, 'Hide', 'red')}
                    </div>
                </div>
            `;
        }

        function createCompactBtn(catId, itemKey, field, value, label, color) {
            const isActive = value === true;
            const colors = {
                green: isActive ? 'bg-emerald-600 text-white border-emerald-700' : 'bg-white text-slate-400 border-slate-200',
                yellow: isActive ? 'bg-amber-500 text-white border-amber-600' : 'bg-white text-slate-400 border-slate-200',
                red: isActive ? 'bg-rose-600 text-white border-rose-700' : 'bg-white text-slate-400 border-slate-200'
            };
            
            return `
                <button 
                    onclick="toggleValue('${catId}', '${itemKey}', '${field}')"
                    class="flex-1 text-[7px] font-black h-3.5 rounded-[2px] border transition-all flex items-center justify-center shadow-xs ${colors[color]}"
                >
                    ${label}
                </button>
            `;
        }

        function toggleValue(catId, itemKey, field) {
            jsonData[catId][itemKey][field] = !jsonData[catId][itemKey][field];
            renderEditor();
        }

        function downloadJson() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(jsonData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "items_modified.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>
</body>
</html>